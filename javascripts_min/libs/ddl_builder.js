define(["jQuery","Handlebars","DateFormat","HandlebarsHelpers/each_with_index"],function(e,t,n){return ddl_builder=function(e){return this.fieldPrefix="",this.fieldSuffix="",this.tablePrefix="",this.tableSuffix="",this.dateFormatMask="yyyy-mm-dd HH:MM:ss",this.charType="varchar",this.intType="int",this.floatType="numeric",this.dateType="datetime",this.valueSeparator="",this.column_count=0,this.definition={tableName:"Table1",columns:[],data:[]},this.ddlTemplate="CREATE TABLE {{{tablePrefix}}}{{tableName}}{{{tableSuffix}}}\n	({{#each_with_index columns}}{{#if index}}, {{/if}}{{{../fieldPrefix}}}{{name}}{{{../fieldSuffix}}} {{db_type}}{{/each_with_index}})\n{{separator}}\n\nINSERT INTO {{{tablePrefix}}}{{tableName}}{{{tableSuffix}}}\n	({{#each_with_index columns}}{{#if index}}, {{/if}}{{{../fieldPrefix}}}{{name}}{{{../fieldSuffix}}}{{/each_with_index}})\nVALUES\n	{{#each_with_index data}}{{#if index}},\n	{{/if}}({{#each_with_index r}}{{#if index}}, {{/if}}{{formatted_field ../..}}{{/each_with_index}}){{/each_with_index}}\n{{separator}}",this.compiledTemplate=t.compile(this.ddlTemplate),this.setup(e),this},ddl_builder.prototype.setup=function(e){for(opt in e)this[opt]=e[opt];return e.ddlTemplate&&(this.compiledTemplate=t.compile(this.ddlTemplate)),e.tableName&&(this.definition.tableName=e.tableName),this},ddl_builder.prototype.setupForDBType=function(e,t){switch(e){case"SQL Server":this.setup({statement_separator:t,fieldPrefix:"[",fieldSuffix:"]",tablePrefix:"[",tableSuffix:"]"});break;case"MySQL":this.setup({statement_separator:t,fieldPrefix:"`",fieldSuffix:"`",tablePrefix:"`",tableSuffix:"`"});break;case"PostgreSQL":this.setup({statement_separator:t,fieldPrefix:'"',fieldSuffix:'"'});break;case"Oracle":var n="CREATE TABLE {{{tablePrefix}}}{{tableName}}{{{tableSuffix}}}\n	({{#each_with_index columns}}{{#if index}}, {{/if}}{{{../fieldPrefix}}}{{name}}{{{../fieldSuffix}}} {{db_type}}{{/each_with_index}})\n{{separator}}\nINSERT ALL{{#each_with_index data}}\n	INTO {{{../tablePrefix}}}{{../tableName}}{{{../tableSuffix}}} ({{#each_with_index r}}{{#if index}}, {{/if}}{{{../../fieldPrefix}}}{{column_name_for_index ../..}}{{{../../fieldSuffix}}}{{/each_with_index}})\n	     VALUES ({{#each_with_index r}}{{#if index}}, {{/if}}{{formatted_field ../..}}{{/each_with_index}}){{/each_with_index}}\nSELECT * FROM dual\n{{separator}}";this.setup({statement_separator:t,ddlTemplate:n,dateType:"timestamp",charType:"varchar2",fieldPrefix:'"',fieldSuffix:'"'});break;case"SQLite":var n="CREATE TABLE {{tablePrefix}}{{tableName}}{{tableSuffix}}\n	({{#each_with_index columns}}{{#if index}}, {{/if}}{{../fieldPrefix}}{{name}}{{../fieldSuffix}} {{db_type}}{{/each_with_index}})\n{{separator}}\n\n{{#each_with_index data}}INSERT INTO {{tablePrefix}}{{../tableName}}{{tableSuffix}}\n	({{#each_with_index ../columns}}{{#if index}}, {{/if}}{{../fieldPrefix}}{{name}}{{../fieldSuffix}}{{/each_with_index}})\nVALUES\n	({{#each_with_index r}}{{#if index}}, {{/if}}{{formatted_field ../..}}{{/each_with_index}})\n{{../separator}}\n{{/each_with_index}}";this.setup({statement_separator:t,ddlTemplate:n,dateType:"TEXT",charType:"TEXT",intType:"INTEGER",floatType:"REAL"})}return this},ddl_builder.prototype.populateDBTypes=function(){for(var e=0;e<this.definition.columns.length;e++)this.definition.columns[e].type=="charType"?this.definition.columns[e].db_type=this[this.definition.columns[e].type]+"("+this.definition.columns[e].length+")":this.definition.columns[e].db_type=this[this.definition.columns[e].type];this.definition.dateFormatMask=this.dateFormatMask},ddl_builder.prototype.populateWrappers=function(){this.definition.fieldPrefix=this.fieldPrefix,this.definition.fieldSuffix=this.fieldSuffix},ddl_builder.prototype.guessValueSeparator=function(t){var n=t.split("\n"),r=!1,i=0,s="";for(var o=0;o<n.length;o++)if(n[o].search(/[A-Z0-9_]/i)!=-1&&!r){var u=e.trim(n[o]).match(/[A-Z0-9_]+([^A-Z0-9_]*)/gi);r=!0;for(var a=0;a<u.length;a++){var f=u[a].match(/[A-Z0-9_]+([^A-Z0-9_]*)$/i)[1];f.search(/^\s+$/)!=-1?f=new RegExp("\\s+"):f=e.trim(f);if(f instanceof RegExp||f.length)if(s instanceof RegExp||!!s.length){if(s.toString()!=f.toString())return{status:!1,message:"Unable to find consistent column separator in header row"}}else s=f;else!(f instanceof RegExp)&&!(s instanceof RegExp)&&!s.length&&(s="\n")}s instanceof RegExp||s.length?i=n[o].split(s).length:i=1}else if(n[o].search(/[A-Z0-9_]/i)!=-1&&n[o].split(s).length!=i)return{status:!1,message:"Line "+o+' does not have the same number of columns as the header, based on separator "'+s+'".'};return{status:!0,separator:s,column_count:i}},ddl_builder.prototype.parse=function(t){if(!this.valueSeparator.length){var n=this.guessValueSeparator(t);if(!n.status)return"ERROR! "+n.message;this.column_count=n.column_count,this.valueSeparator=n.separator}var r=t.split("\n");for(var i=0;i<r.length;i++)if(e.trim(r[i]).length&&r[i].split(this.valueSeparator).length==this.column_count){var s=e.trim(r[i]).split(this.valueSeparator);if(!this.definition.columns.length)for(var o=0;o<s.length;o++){var u=e.trim(s[o]);u.length?this.definition.columns.push({name:u}):this.definition.columns.push(!1)}else{var a=[];for(var o=0;o<s.length;o++)if(this.definition.columns[o]!==!1){var u=e.trim(s[o]).replace(/'/g,"''");isNaN(u)||this.definition.columns[o].type=="dateType"||this.definition.columns[o].type=="charType"?this.definition.columns[o].type!="charType"&&!isNaN(Date.parse(u))?this.definition.columns[o].type="dateType":this.definition.columns[o].type="charType":this.definition.columns[o].type!="floatType"&&u%1!=0?this.definition.columns[o].type="floatType":this.definition.columns[o].type="intType";if(!this.definition.columns[o].length||u.length>this.definition.columns[o].length)this.definition.columns[o].length=u.length;a.push({v:u})}this.definition.data.push({r:a})}}return this.populateDBTypes(),this.populateWrappers(),this.render()},t.registerHelper("formatted_field",function(e){var r="",i=-1;for(var s=0;s<e.columns.length;s++){e.columns[s]&&i++;if(i==this.index){r=e.columns[s].type;break}}return!this.v.length||this.v.toUpperCase()=="NULL"?"NULL":r=="charType"?new t.SafeString("'"+this.v.replace(/'/g,"''")+"'"):r=="dateType"?new t.SafeString("'"+n(this.v,e.dateFormatMask)+"'"):this.v}),t.registerHelper("column_name_for_index",function(e){return e.columns[this.index].name}),t.registerHelper("each_with_index",function(e,t){var n="";k=0;for(var r=0,i=e.length;r<i;r++)if(e[r]){var s=e[r];s.index=k,s.first=k==0,s.last=k==e.length,n+=t(s),k++}return n}),ddl_builder.prototype.render=function(){return this.compiledTemplate(e.extend(this.definition,{separator:this.statement_separator}))},ddl_builder})